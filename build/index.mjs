var q={"llama-3-70b":"llama3-70b-8192","gpt-4o":"gpt-4o-2024-08-06","gpt-4o-mini":"gpt-4o-mini","claude-3.5-sonnet":"claude-3.5-sonnet-20240620","claude-3-opus":"claude-3-opus-20240229","claude-3-sonnet":"claude-3-sonnet-20240229","claude-3-haiku":"claude-3-haiku-20240307"},w={groq:["llama-3-70b"],openai:["gpt-4o","gpt-4o-mini"],anthropic:["claude-3.5-sonnet","claude-3-opus","claude-3-haiku","claude-3-sonnet"]},_="llama-3-70b",T="groq",F={groq:"https://api.groq.com/openai/v1/chat/completions",openai:"https://api.openai.com/v1/chat/completions",anthropic:"https://api.anthropic.com/v1/messages"},U=.3;var V=new Set(['"',"'","`","{","}","[","]","(",")",","," ",":","."]);var x=class t{constructor(){}static getInstance(){return t.instance||(t.instance=new t),t.instance}error(e,o){console.error(this.styleMessage(o.message,e,"error")),o.stack&&console.error(this.styleStackTrace(o.stack))}warn(e,o){console.warn(this.styleMessage(o,e,"warning"))}styleMessage(e,o,r){let i=this.getTimestamp(),n="Please create an issue on GitHub if the issue persists.",s=100,l="\u2500".repeat(s-2),a=`\u250C${l}\u2510`,p=`\u2514${l}\u2518`,c=((A,pe)=>{let me=A.split(" "),N=[],C="";return me.forEach($=>{(C+$).length>pe&&(N.push(C.trim()),C=""),C+=$+" "}),C.trim()&&N.push(C.trim()),N})(e,s-4),P=[a,...c.map(A=>`\u2502 ${A.padEnd(s-4)} \u2502`),p].join(`
`);return`
\x1B[1m\x1B[37m[${i}]\x1B[0m${r==="error"?"\x1B[31m":"\x1B[33m"} [${o}]\x1B[0m \x1B[2m${n}\x1B[0m
${P}
`}styleStackTrace(e){return e.split(`
`).map((i,n)=>n===0?`\x1B[31m${i}\x1B[0m`:`\x1B[2m${i}\x1B[0m`).join(`
`)}getTimestamp(){return new Date().toISOString()}};var h=class h{constructor(){this.logger=x.getInstance()}static getInstance(){return h.instance}handleError(e,o){let r=this.getErrorDetails(e);return this.logger.error(o,r),r}getErrorDetails(e){return e instanceof Error?{message:e.message,name:e.name,stack:e.stack,context:e.context}:{message:String(e),name:"UnknownError"}}};h.instance=new h;var S=h;var m=(t,e)=>S.getInstance().handleError(t,e);var j={"claude-3.5-sonnet":8192,"claude-3-opus":4096,"claude-3-haiku":4096,"claude-3-sonnet":4096};var R="<<CURSOR>>",G=(t,e)=>"You are an advanced AI content creation assistant. Your goal is to provide accurate, efficient, and context-aware completions. Remember, your role is to act as an extension of the writer's thought process, providing intelligent and contextually appropriate content completions.",W=(t,e)=>{let{editorState:{completionMode:o},textBeforeCursor:r,textAfterCursor:i,externalContext:n}=t,s="You are are given an incomplete piece of content and asked what the following text is. Treat the given content as markdown text.";return s+=`

Here are the details about how the completion should be generated:
  - The cursor position is marked with '${R}'.
  - Your completion must start exactly at the cursor position.
  - Do not repeat any content that appears before or after the cursor.
`,o==="fill-in-the-middle"?s+=`  - If filling in the middle, replace '${R}' entirely with your completion.
`:o==="completion"&&(s+=`  - If completing the code, start from '${R}' and provide a logical continuation.
`),s+=`  - Optimize for readability and effectiveness where possible.

  Remember to output only the completion content without any additional explanation.

  Here's the snippet for completion:

  <code>
  ${r}${R}${i}
  </code>`,n&&n.length>0&&(s+=`

Additional context from related files:

`,s+=n.map(l=>`// Path: ${l.path}
${l.content}
`).join(`
`)),s.endsWith(".")?s:`${s}.`};var Y=(t,e,o,r)=>{let i=G(t,r),n=W(t,r),l={model:Ce(e),temperature:U},a={openai:{messages:[{role:"system",content:i},{role:"user",content:n}]},groq:{messages:[{role:"system",content:i},{role:"user",content:n}]},anthropic:{system:i,messages:[{role:"user",content:n}],max_tokens:ge(e)}};return{...l,...a[o]}},K=(t,e)=>{let o={"Content-Type":"application/json"},r={openai:{Authorization:`Bearer ${t}`},groq:{Authorization:`Bearer ${t}`},anthropic:{"x-api-key":t,"anthropic-version":"2023-06-01"}};return{...o,...r[e]}},X=(t,e)=>{let r={openai:ce,groq:de,anthropic:ue}[e];if(!r)throw new Error(`Unsupported provider: ${e}`);return r(t)},ce=t=>t.choices?.length?{completion:t.choices[0].message.content}:{completion:null,error:"No completion found in the openai response"},de=t=>t.choices?.length?{completion:t.choices[0].message.content}:{completion:null,error:"No completion found in the groq response"},ue=t=>t.content?typeof t.content!="string"?{completion:null,error:"Completion content is not a string"}:{completion:t.content}:{completion:null,error:"No completion found in the anthropic response"},Ce=t=>q[t],z=t=>F[t],ge=t=>j[t]||4096;var J=(t,e)=>{let o=null,r=null,i=(...n)=>new Promise((s,l)=>{o&&(clearTimeout(o),r&&r("Cancelled")),r=l,o=setTimeout(()=>{s(t(...n)),r=null},e)});return i.cancel=()=>{o&&(clearTimeout(o),r&&r("Cancelled"),o=null,r=null)},i},Z=t=>!t||t.length===0?"":t.length===1?t[0]:`${t.slice(0,-1).join(", ")} and ${t.slice(-1)}`;var y=(t,e)=>e.getLineContent(t.lineNumber)[t.column-1],Q=(t,e)=>e.getLineContent(t.lineNumber).slice(t.column-1),g=(t,e)=>e.getLineContent(t.lineNumber).slice(0,t.column-1),ee=t=>{let e=t.split(`
`);return e[e.length-1].length+1};var D=(t,e)=>e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:t.lineNumber,endColumn:t.column}),k=(t,e)=>e.getValueInRange({startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:e.getLineCount(),endColumn:e.getLineMaxColumn(e.getLineCount())});var te=async(t,e,o={})=>{let r={"Content-Type":"application/json",...o.headers},i=e==="POST"&&o.body?JSON.stringify(o.body):void 0,n=await fetch(t,{method:e,headers:r,body:i,signal:o.signal});if(!n.ok)throw new Error(`${o.error||"Network error"}: ${n.statusText}`);return n.json()},he=(t,e)=>te(t,"GET",e),fe=(t,e,o)=>te(t,"POST",{...o,body:e}),M={GET:he,POST:fe};var oe=(t,e)=>{let o=y(t,e);return!!o&&!V.has(o)},re=(t,e)=>{let o=Q(t,e).trim(),r=g(t,e).trim();return t.column<=3&&(o!==""||r!=="")};var B=class{constructor(e,o={}){this.validateInputs(e,o),this.apiKey=e,this.provider=o.provider??T,this.model=o.model??_}async complete({body:e,options:o}){let{completionMetadata:r}=e,{headers:i={}}=o??{};try{let n=Y(r,this.model,this.provider,o),s=z(this.provider),l=K(this.apiKey,this.provider),a={...i,...l},p=await M.POST(s,n,{headers:a});return X(p,this.provider)}catch(n){return{error:m(n,"COPILOT_COMPLETION_FETCH_ERROR").message,completion:null}}}validateInputs(e,o){if(!e)throw new Error(`Please provide ${this.provider??T} API key.`);let{provider:r,model:i}=o;if(r&&!i||!r&&i)throw new Error("Both provider and model must be specified together");let n=r??T,s=i??_;if(!w[n].includes(s)){let l=Z(w[n]);throw new Error(`Model ${s} is not supported by ${n} provider. Supported models: ${l}`)}}};var I=class t{constructor(e){this.formattedCompletion="";this.formattedCompletion=e}static create(e){return new t(e)}setCompletion(e){return this.formattedCompletion=e,this}removeInvalidLineBreaks(){return this.formattedCompletion=this.formattedCompletion.trimEnd(),this}removeMarkdownCodeSyntax(){return this.formattedCompletion=this.removeMarkdownCodeBlocks(this.formattedCompletion),this}removeMarkdownCodeBlocks(e){let o=/```[\s\S]*?```/g,r=e,i;for(;(i=o.exec(e))!==null;){let n=i[0],s=n.split(`
`).slice(1,-1).join(`
`);r=r.replace(n,s)}return r.trim()}removeExcessiveNewlines(){return this.formattedCompletion=this.formattedCompletion.replace(/\n{3,}/g,`

`),this}build(){return this.formattedCompletion}};var O=class{constructor(e,o){this.cursorPosition=e,this.model=o}shouldProvideCompletions(){return!oe(this.cursorPosition,this.model)&&!re(this.cursorPosition,this.model)}};var v=class v{constructor(){this.cache=[]}getCompletionCache(e,o){return this.cache.filter(r=>this.isCacheItemValid(r,e,o))}addCompletionCache(e){this.cache=[...this.cache.slice(-(v.MAX_CACHE_SIZE-1)),e]}clearCompletionCache(){this.cache=[]}isCacheItemValid(e,o,r){let i=r.getValueInRange(e.range);return g(o,r).startsWith(e.textBeforeCursorInLine)&&this.isPositionValid(e,o,i)}isPositionValid(e,o,r){return e.range.startLineNumber===o.lineNumber&&o.column===e.range.startColumn||e.completion.startsWith(r)&&e.range.startLineNumber===o.lineNumber&&o.column>=e.range.startColumn-r.length&&o.column<=e.range.endColumn}};v.MAX_CACHE_SIZE=10;var b=v;var Ee="application/json",ne=async({filename:t,endpoint:e,language:o,technologies:r,externalContext:i,model:n,position:s})=>{try{let{completion:l}=await M.POST(e,{body:{completionMetadata:Pe({filename:t,position:s,model:n,language:o,technologies:r,externalContext:i})}},{headers:{"Content-Type":Ee},error:"Error while fetching completion item"});return l}catch(l){return m(l,"FETCH_COMPLETION_ITEM_ERROR"),null}},Pe=({filename:t,position:e,model:o,language:r,technologies:i,externalContext:n})=>{let s=Te(e,o),l=D(e,o),a=k(e,o);return{filename:t,language:r,technologies:i,externalContext:n,textBeforeCursor:l,textAfterCursor:a,editorState:{completionMode:s}}},Te=(t,e)=>{let o=D(t,e),r=k(t,e);return o&&r?"fill-in-the-middle":"completion"};var ie=(t,e,o,r)=>{let i=(t.match(/\n/g)||[]).length,n=ee(t),s=y(o,r);return{startLineNumber:o.lineNumber,startColumn:o.column,endLineNumber:o.lineNumber+i,endColumn:t.includes(s)?o.lineNumber===e.startLineNumber&&i===0?o.column+(n-1):n:o.column}};function se(t){return I.create(t).removeMarkdownCodeSyntax().removeExcessiveNewlines().removeInvalidLineBreaks().build()}var d=t=>({items:t,enableForwardStability:!0});var xe=300,le=J(ne,xe),L=new b,Re=async({monaco:t,model:e,position:o,token:r,isCompletionAccepted:i,onShowCompletion:n,options:s})=>{if(!new O(o,e).shouldProvideCompletions())return d([]);let l=L.getCompletionCache(o,e).map(a=>({insertText:a.completion,range:a.range}));if(l.length)return n(),d(l);if(r.isCancellationRequested||i)return d([]);try{let a=le({...s,text:e.getValue(),model:e,position:o});r.onCancellationRequested(()=>{le.cancel()});let p=await a;if(p){let u=se(p),c=new t.Range(o.lineNumber,o.column,o.lineNumber,o.column),P=ie(u,c,o,e);return L.addCompletionCache({completion:u,range:P,textBeforeCursorInLine:g(o,e)}),n(),d([{insertText:u,range:P}])}}catch(a){if(typeof a=="string"&&(a==="Cancelled"||a==="AbortError")||a instanceof Error&&(a.message==="Cancelled"||a.name==="AbortError"))return d([]);m(a,"FETCH_COMPLETION_ITEM_ERROR")}return d([])},ae=Re;var f=new WeakMap,E=null,ye=(t,e,o)=>{E&&E.deregister();let r=[];f.set(e,{isCompletionAccepted:!1,isCompletionVisible:!1});try{let i=t.languages.registerInlineCompletionsProvider(o.language,{provideInlineCompletions:(l,a,p,u)=>{let c=f.get(e);if(c)return ae({monaco:t,model:l,position:a,token:u,isCompletionAccepted:c.isCompletionAccepted,onShowCompletion:()=>{c.isCompletionVisible=!0},options:o})},freeInlineCompletions:()=>{}});r.push(i);let n=e.onKeyDown(l=>{let a=f.get(e);if(!a)return;let p=l.keyCode===t.KeyCode.Tab||l.keyCode===t.KeyCode.RightArrow&&l.metaKey;a.isCompletionVisible&&p?(a.isCompletionAccepted=!0,a.isCompletionVisible=!1):a.isCompletionAccepted=!1});r.push(n);let s={deregister:()=>{r.forEach(l=>l.dispose()),L.clearCompletionCache(),f.delete(e),E=null}};return E=s,s}catch(i){return m(i,"REGISTER_COPILOT_ERROR"),{deregister:()=>{r.forEach(n=>n.dispose()),f.delete(e),E=null}}}};export{B as Copilot,ye as registerCopilot};
