var q={"llama-3-70b":"llama3-70b-8192","gpt-4o":"gpt-4o-2024-08-06","gpt-4o-mini":"gpt-4o-mini","claude-3.5-sonnet":"claude-3.5-sonnet-20240620","claude-3-opus":"claude-3-opus-20240229","claude-3-sonnet":"claude-3-sonnet-20240229","claude-3-haiku":"claude-3-haiku-20240307"},_={groq:["llama-3-70b"],openai:["gpt-4o","gpt-4o-mini"],anthropic:["claude-3.5-sonnet","claude-3-opus","claude-3-haiku","claude-3-sonnet"]},w="llama-3-70b",T="groq",F={groq:"https://api.groq.com/openai/v1/chat/completions",openai:"https://api.openai.com/v1/chat/completions",anthropic:"https://api.anthropic.com/v1/messages"},U=.3;var V=new Set(['"',"'","`","{","}","[","]","(",")",","," ",":","."]);var x=class o{constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}error(e,t){console.error(this.styleMessage(t.message,e,"error")),t.stack&&console.error(this.styleStackTrace(t.stack))}warn(e,t){console.warn(this.styleMessage(t,e,"warning"))}styleMessage(e,t,r){let i=this.getTimestamp(),n="Please create an issue on GitHub if the issue persists.",s=100,l="\u2500".repeat(s-2),a=`\u250C${l}\u2510`,p=`\u2514${l}\u2518`,c=((A,pe)=>{let me=A.split(" "),N=[],C="";return me.forEach($=>{(C+$).length>pe&&(N.push(C.trim()),C=""),C+=$+" "}),C.trim()&&N.push(C.trim()),N})(e,s-4),P=[a,...c.map(A=>`\u2502 ${A.padEnd(s-4)} \u2502`),p].join(`
`);return`
\x1B[1m\x1B[37m[${i}]\x1B[0m${r==="error"?"\x1B[31m":"\x1B[33m"} [${t}]\x1B[0m \x1B[2m${n}\x1B[0m
${P}
`}styleStackTrace(e){return e.split(`
`).map((i,n)=>n===0?`\x1B[31m${i}\x1B[0m`:`\x1B[2m${i}\x1B[0m`).join(`
`)}getTimestamp(){return new Date().toISOString()}};var h=class h{constructor(){this.logger=x.getInstance()}static getInstance(){return h.instance}handleError(e,t){let r=this.getErrorDetails(e);return this.logger.error(t,r),r}getErrorDetails(e){return e instanceof Error?{message:e.message,name:e.name,stack:e.stack,context:e.context}:{message:String(e),name:"UnknownError"}}};h.instance=new h;var S=h;var m=(o,e)=>S.getInstance().handleError(o,e);var j={"claude-3.5-sonnet":8192,"claude-3-opus":4096,"claude-3-haiku":4096,"claude-3-sonnet":4096};var R="<<CURSOR>>",G=(o,e)=>e.systemPrompt,W=(o,e)=>{let{editorState:{completionMode:t},textBeforeCursor:r,textAfterCursor:i,externalContext:n}=o,s="";return s+=`

Here are the details about how the completion should be generated:
  - The cursor position is marked with '${R}'.
  - Your completion must start exactly at the cursor position.
  - Do not repeat any content that appears before or after the cursor.
`,t==="fill-in-the-middle"?s+=`  - If filling in the middle, replace '${R}' entirely with your completion.
`:t==="completion"&&(s+=`  - If completing the code, start from '${R}' and provide a logical continuation.
`),s+=`  - Optimize for readability and effectiveness where possible.

  Remember to output only the completion content without any additional explanation.

  Here's the snippet for completion:

  <code>
  ${r}${R}${i}
  </code>`,n&&n.length>0&&(s+=`

Additional context from related files:

`,s+=n.map(l=>`// Path: ${l.path}
${l.content}
`).join(`
`)),s.endsWith(".")?s:`${s}.`};var Y=(o,e,t,r)=>{let i=G(o,r),n=W(o,r),l={model:Ce(e),temperature:U},a={openai:{messages:[{role:"system",content:i},{role:"user",content:n}]},groq:{messages:[{role:"system",content:i},{role:"user",content:n}]},anthropic:{system:i,messages:[{role:"user",content:n}],max_tokens:ge(e)}};return{...l,...a[t]}},K=(o,e)=>{let t={"Content-Type":"application/json"},r={openai:{Authorization:`Bearer ${o}`},groq:{Authorization:`Bearer ${o}`},anthropic:{"x-api-key":o,"anthropic-version":"2023-06-01"}};return{...t,...r[e]}},X=(o,e)=>{let r={openai:ce,groq:de,anthropic:ue}[e];if(!r)throw new Error(`Unsupported provider: ${e}`);return r(o)},ce=o=>o.choices?.length?{completion:o.choices[0].message.content}:{completion:null,error:"No completion found in the openai response"},de=o=>o.choices?.length?{completion:o.choices[0].message.content}:{completion:null,error:"No completion found in the groq response"},ue=o=>o.content?typeof o.content!="string"?{completion:null,error:"Completion content is not a string"}:{completion:o.content}:{completion:null,error:"No completion found in the anthropic response"},Ce=o=>q[o],z=o=>F[o],ge=o=>j[o]||4096;var J=(o,e)=>{let t=null,r=null,i=(...n)=>new Promise((s,l)=>{t&&(clearTimeout(t),r&&r("Cancelled")),r=l,t=setTimeout(()=>{s(o(...n)),r=null},e)});return i.cancel=()=>{t&&(clearTimeout(t),r&&r("Cancelled"),t=null,r=null)},i},Z=o=>!o||o.length===0?"":o.length===1?o[0]:`${o.slice(0,-1).join(", ")} and ${o.slice(-1)}`;var y=(o,e)=>e.getLineContent(o.lineNumber)[o.column-1],Q=(o,e)=>e.getLineContent(o.lineNumber).slice(o.column-1),g=(o,e)=>e.getLineContent(o.lineNumber).slice(0,o.column-1),ee=o=>{let e=o.split(`
`);return e[e.length-1].length+1};var D=(o,e)=>e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),k=(o,e)=>e.getValueInRange({startLineNumber:o.lineNumber,startColumn:o.column,endLineNumber:e.getLineCount(),endColumn:e.getLineMaxColumn(e.getLineCount())});var oe=async(o,e,t={})=>{let r={"Content-Type":"application/json",...t.headers},i=e==="POST"&&t.body?JSON.stringify(t.body):void 0,n=await fetch(o,{method:e,headers:r,body:i,signal:t.signal});if(!n.ok)throw new Error(`${t.error||"Network error"}: ${n.statusText}`);return n.json()},he=(o,e)=>oe(o,"GET",e),fe=(o,e,t)=>oe(o,"POST",{...t,body:e}),M={GET:he,POST:fe};var te=(o,e)=>{let t=y(o,e);return!!t&&!V.has(t)},re=(o,e)=>{let t=Q(o,e).trim(),r=g(o,e).trim();return o.column<=3&&(t!==""||r!=="")};var B=class{constructor(e,t={}){this.validateInputs(e,t),this.apiKey=e,this.provider=t.provider??T,this.model=t.model??w}async complete({body:e,options:t}){let{completionMetadata:r}=e,{headers:i={}}=t??{};try{let n=Y(r,this.model,this.provider,t),s=z(this.provider),l=K(this.apiKey,this.provider),a={...i,...l},p=await M.POST(s,n,{headers:a});return X(p,this.provider)}catch(n){return{error:m(n,"COPILOT_COMPLETION_FETCH_ERROR").message,completion:null}}}validateInputs(e,t){if(!e)throw new Error(`Please provide ${this.provider??T} API key.`);let{provider:r,model:i}=t;if(r&&!i||!r&&i)throw new Error("Both provider and model must be specified together");let n=r??T,s=i??w;if(!_[n].includes(s)){let l=Z(_[n]);throw new Error(`Model ${s} is not supported by ${n} provider. Supported models: ${l}`)}}};var I=class o{constructor(e){this.formattedCompletion="";this.formattedCompletion=e}static create(e){return new o(e)}setCompletion(e){return this.formattedCompletion=e,this}removeInvalidLineBreaks(){return this.formattedCompletion=this.formattedCompletion.trimEnd(),this}removeMarkdownCodeSyntax(){return this.formattedCompletion=this.removeMarkdownCodeBlocks(this.formattedCompletion),this}removeMarkdownCodeBlocks(e){let t=/```[\s\S]*?```/g,r=e,i;for(;(i=t.exec(e))!==null;){let n=i[0],s=n.split(`
`).slice(1,-1).join(`
`);r=r.replace(n,s)}return r.trim()}removeExcessiveNewlines(){return this.formattedCompletion=this.formattedCompletion.replace(/\n{3,}/g,`

`),this}build(){return this.formattedCompletion}};var O=class{constructor(e,t){this.cursorPosition=e,this.model=t}shouldProvideCompletions(){return!te(this.cursorPosition,this.model)&&!re(this.cursorPosition,this.model)}};var v=class v{constructor(){this.cache=[]}getCompletionCache(e,t){return this.cache.filter(r=>this.isCacheItemValid(r,e,t))}addCompletionCache(e){this.cache=[...this.cache.slice(-(v.MAX_CACHE_SIZE-1)),e]}clearCompletionCache(){this.cache=[]}isCacheItemValid(e,t,r){let i=r.getValueInRange(e.range);return g(t,r).startsWith(e.textBeforeCursorInLine)&&this.isPositionValid(e,t,i)}isPositionValid(e,t,r){return e.range.startLineNumber===t.lineNumber&&t.column===e.range.startColumn||e.completion.startsWith(r)&&e.range.startLineNumber===t.lineNumber&&t.column>=e.range.startColumn-r.length&&t.column<=e.range.endColumn}};v.MAX_CACHE_SIZE=10;var b=v;var Ee="application/json",ne=async({filename:o,endpoint:e,language:t,technologies:r,externalContext:i,model:n,position:s})=>{try{let{completion:l}=await M.POST(e,{body:{completionMetadata:Pe({filename:o,position:s,model:n,language:t,technologies:r,externalContext:i})}},{headers:{"Content-Type":Ee},error:"Error while fetching completion item"});return l}catch(l){return m(l,"FETCH_COMPLETION_ITEM_ERROR"),null}},Pe=({filename:o,position:e,model:t,language:r,technologies:i,externalContext:n})=>{let s=Te(e,t),l=D(e,t),a=k(e,t);return{filename:o,language:r,technologies:i,externalContext:n,textBeforeCursor:l,textAfterCursor:a,editorState:{completionMode:s}}},Te=(o,e)=>{let t=D(o,e),r=k(o,e);return t&&r?"fill-in-the-middle":"completion"};var ie=(o,e,t,r)=>{let i=(o.match(/\n/g)||[]).length,n=ee(o),s=y(t,r);return{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber+i,endColumn:o.includes(s)?t.lineNumber===e.startLineNumber&&i===0?t.column+(n-1):n:t.column}};function se(o){return I.create(o).removeMarkdownCodeSyntax().removeExcessiveNewlines().removeInvalidLineBreaks().build()}var d=o=>({items:o,enableForwardStability:!0});var xe=300,le=J(ne,xe),L=new b,Re=async({monaco:o,model:e,position:t,token:r,isCompletionAccepted:i,onShowCompletion:n,options:s})=>{if(!new O(t,e).shouldProvideCompletions())return d([]);let l=L.getCompletionCache(t,e).map(a=>({insertText:a.completion,range:a.range}));if(l.length)return n(),d(l);if(r.isCancellationRequested||i)return d([]);try{let a=le({...s,text:e.getValue(),model:e,position:t});r.onCancellationRequested(()=>{le.cancel()});let p=await a;if(p){let u=se(p),c=new o.Range(t.lineNumber,t.column,t.lineNumber,t.column),P=ie(u,c,t,e);return L.addCompletionCache({completion:u,range:P,textBeforeCursorInLine:g(t,e)}),n(),d([{insertText:u,range:P}])}}catch(a){if(typeof a=="string"&&(a==="Cancelled"||a==="AbortError")||a instanceof Error&&(a.message==="Cancelled"||a.name==="AbortError"))return d([]);m(a,"FETCH_COMPLETION_ITEM_ERROR")}return d([])},ae=Re;var f=new WeakMap,E=null,ye=(o,e,t)=>{E&&E.deregister();let r=[];f.set(e,{isCompletionAccepted:!1,isCompletionVisible:!1});try{let i=o.languages.registerInlineCompletionsProvider(t.language,{provideInlineCompletions:(l,a,p,u)=>{let c=f.get(e);if(c)return ae({monaco:o,model:l,position:a,token:u,isCompletionAccepted:c.isCompletionAccepted,onShowCompletion:()=>{c.isCompletionVisible=!0},options:t})},freeInlineCompletions:()=>{}});r.push(i);let n=e.onKeyDown(l=>{let a=f.get(e);if(!a)return;let p=l.keyCode===o.KeyCode.Tab||l.keyCode===o.KeyCode.RightArrow&&l.metaKey;a.isCompletionVisible&&p?(a.isCompletionAccepted=!0,a.isCompletionVisible=!1):a.isCompletionAccepted=!1});r.push(n);let s={deregister:()=>{r.forEach(l=>l.dispose()),L.clearCompletionCache(),f.delete(e),E=null}};return E=s,s}catch(i){return m(i,"REGISTER_COPILOT_ERROR"),{deregister:()=>{r.forEach(n=>n.dispose()),f.delete(e),E=null}}}};export{B as Copilot,ye as registerCopilot};
