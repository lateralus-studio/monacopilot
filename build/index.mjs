var q={"llama-3-70b":"llama3-70b-8192","gpt-4o":"gpt-4o-2024-08-06","gpt-4o-mini":"gpt-4o-mini","claude-3.5-sonnet":"claude-3.5-sonnet-20240620","claude-3-opus":"claude-3-opus-20240229","claude-3-sonnet":"claude-3-sonnet-20240229","claude-3-haiku":"claude-3-haiku-20240307"},w={groq:["llama-3-70b"],openai:["gpt-4o","gpt-4o-mini"],anthropic:["claude-3.5-sonnet","claude-3-opus","claude-3-haiku","claude-3-sonnet"]},_="llama-3-70b",T="groq",F={groq:"https://api.groq.com/openai/v1/chat/completions",openai:"https://api.openai.com/v1/chat/completions",anthropic:"https://api.anthropic.com/v1/messages"},U=.3;var V=new Set(['"',"'","`","{","}","[","]","(",")",","," ",":","."]);var x=class o{constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}error(e,t){console.error(this.styleMessage(t.message,e,"error")),t.stack&&console.error(this.styleStackTrace(t.stack))}warn(e,t){console.warn(this.styleMessage(t,e,"warning"))}styleMessage(e,t,r){let s=this.getTimestamp(),n="Please create an issue on GitHub if the issue persists.",l=100,a="\u2500".repeat(l-2),i=`\u250C${a}\u2510`,p=`\u2514${a}\u2518`,m=((A,pe)=>{let ce=A.split(" "),N=[],C="";return ce.forEach(H=>{(C+H).length>pe&&(N.push(C.trim()),C=""),C+=H+" "}),C.trim()&&N.push(C.trim()),N})(e,l-4),P=[i,...m.map(A=>`\u2502 ${A.padEnd(l-4)} \u2502`),p].join(`
`);return`
\x1B[1m\x1B[37m[${s}]\x1B[0m${r==="error"?"\x1B[31m":"\x1B[33m"} [${t}]\x1B[0m \x1B[2m${n}\x1B[0m
${P}
`}styleStackTrace(e){return e.split(`
`).map((s,n)=>n===0?`\x1B[31m${s}\x1B[0m`:`\x1B[2m${s}\x1B[0m`).join(`
`)}getTimestamp(){return new Date().toISOString()}};var h=class h{constructor(){this.logger=x.getInstance()}static getInstance(){return h.instance}handleError(e,t){let r=this.getErrorDetails(e);return this.logger.error(t,r),r}getErrorDetails(e){return e instanceof Error?{message:e.message,name:e.name,stack:e.stack,context:e.context}:{message:String(e),name:"UnknownError"}}};h.instance=new h;var S=h;var c=(o,e)=>S.getInstance().handleError(o,e);var j={"claude-3.5-sonnet":8192,"claude-3-opus":4096,"claude-3-haiku":4096,"claude-3-sonnet":4096};var y="<<CURSOR>>";var me=o=>{switch(o){case"fill-in-the-middle":return"filling in the middle of the code";case"completion":return"completing the code"}},G=o=>"You are an advanced AI coding assistant with expertise in AI prompt engineering and creating concise and efficient AI prompts. Your goal is to provide accurate, efficient, and context-aware code completions. Remember, your role is to act as an extension of the developer's thought process, providing intelligent and contextually appropriate prompt completions.",de=(o,e)=>!o?.length&&!e?"":"The code is written in markdown and is meant to be used as an AI prompt.",W=o=>{let{language:e,technologies:t,editorState:{completionMode:r},textBeforeCursor:s,textAfterCursor:n,externalContext:l}=o,i=`You are tasked with ${me(r)} for a markdown snippet.

`;return i+=de(t,e),i+=`

Here are the details about how the completion should be generated:
  - The cursor position is marked with '${y}'.
  - Your completion must start exactly at the cursor position.
  - Do not repeat any code that appears before or after the cursor.
  - Ensure your completion does not introduce any syntactical or logical errors.
`,r==="fill-in-the-middle"?i+=`  - If filling in the middle, replace '${y}' entirely with your completion.
`:r==="completion"&&(i+=`  - If completing the code, start from '${y}' and provide a logical continuation.
`),i+=`  - Optimize for readability and performance where possible.

  Remember to output only the completion code without any additional explanation, and do not wrap it in markdown code syntax, such as three backticks (\`\`\`).

  Here's the code snippet for completion:

  <code>
  ${s}${y}${n}
  </code>`,l&&l.length>0&&(i+=`

Additional context from related files:

`,i+=l.map(p=>`// Path: ${p.path}
${p.content}
`).join(`
`)),i.endsWith(".")?i:`${i}.`};var Y=(o,e,t,r)=>{let s=G(o,r),n=W(o,r),a={model:he(e),temperature:U},i={openai:{messages:[{role:"system",content:s},{role:"user",content:n}]},groq:{messages:[{role:"system",content:s},{role:"user",content:n}]},anthropic:{system:s,messages:[{role:"user",content:n}],max_tokens:fe(e)}};return console.log({...a,...i[t]}),{...a,...i[t]}},K=(o,e)=>{let t={"Content-Type":"application/json"},r={openai:{Authorization:`Bearer ${o}`},groq:{Authorization:`Bearer ${o}`},anthropic:{"x-api-key":o,"anthropic-version":"2023-06-01"}};return{...t,...r[e]}},X=(o,e)=>{let r={openai:ue,groq:Ce,anthropic:ge}[e];if(!r)throw new Error(`Unsupported provider: ${e}`);return r(o)},ue=o=>o.choices?.length?{completion:o.choices[0].message.content}:{completion:null,error:"No completion found in the openai response"},Ce=o=>o.choices?.length?{completion:o.choices[0].message.content}:{completion:null,error:"No completion found in the groq response"},ge=o=>o.content?typeof o.content!="string"?{completion:null,error:"Completion content is not a string"}:{completion:o.content}:{completion:null,error:"No completion found in the anthropic response"},he=o=>q[o],z=o=>F[o],fe=o=>j[o]||4096;var J=(o,e)=>{let t=null,r=null,s=(...n)=>new Promise((l,a)=>{t&&(clearTimeout(t),r&&r("Cancelled")),r=a,t=setTimeout(()=>{l(o(...n)),r=null},e)});return s.cancel=()=>{t&&(clearTimeout(t),r&&r("Cancelled"),t=null,r=null)},s},Z=o=>!o||o.length===0?"":o.length===1?o[0]:`${o.slice(0,-1).join(", ")} and ${o.slice(-1)}`;var M=(o,e)=>e.getLineContent(o.lineNumber)[o.column-1],Q=(o,e)=>e.getLineContent(o.lineNumber).slice(o.column-1),g=(o,e)=>e.getLineContent(o.lineNumber).slice(0,o.column-1),ee=o=>{let e=o.split(`
`);return e[e.length-1].length+1};var D=(o,e)=>e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),k=(o,e)=>e.getValueInRange({startLineNumber:o.lineNumber,startColumn:o.column,endLineNumber:e.getLineCount(),endColumn:e.getLineMaxColumn(e.getLineCount())});var oe=async(o,e,t={})=>{let r={"Content-Type":"application/json",...t.headers},s=e==="POST"&&t.body?JSON.stringify(t.body):void 0,n=await fetch(o,{method:e,headers:r,body:s,signal:t.signal});if(!n.ok)throw new Error(`${t.error||"Network error"}: ${n.statusText}`);return n.json()},Ee=(o,e)=>oe(o,"GET",e),Pe=(o,e,t)=>oe(o,"POST",{...t,body:e}),R={GET:Ee,POST:Pe};var te=(o,e)=>{let t=M(o,e);return!!t&&!V.has(t)},re=(o,e)=>{let t=Q(o,e).trim(),r=g(o,e).trim();return o.column<=3&&(t!==""||r!=="")};var B=class{constructor(e,t={}){this.validateInputs(e,t),this.apiKey=e,this.provider=t.provider??T,this.model=t.model??_}async complete({body:e,options:t}){let{completionMetadata:r}=e,{headers:s={}}=t??{};try{let n=Y(r,this.model,this.provider,t),l=z(this.provider),a=K(this.apiKey,this.provider),i={...s,...a},p=await R.POST(l,n,{headers:i});return X(p,this.provider)}catch(n){return{error:c(n,"COPILOT_COMPLETION_FETCH_ERROR").message,completion:null}}}validateInputs(e,t){if(!e)throw new Error(`Please provide ${this.provider??T} API key.`);let{provider:r,model:s}=t;if(r&&!s||!r&&s)throw new Error("Both provider and model must be specified together");let n=r??T,l=s??_;if(!w[n].includes(l)){let a=Z(w[n]);throw new Error(`Model ${l} is not supported by ${n} provider. Supported models: ${a}`)}}};var I=class o{constructor(e){this.formattedCompletion="";this.formattedCompletion=e}static create(e){return new o(e)}setCompletion(e){return this.formattedCompletion=e,this}removeInvalidLineBreaks(){return this.formattedCompletion=this.formattedCompletion.trimEnd(),this}removeMarkdownCodeSyntax(){return this.formattedCompletion=this.removeMarkdownCodeBlocks(this.formattedCompletion),this}removeMarkdownCodeBlocks(e){let t=/```[\s\S]*?```/g,r=e,s;for(;(s=t.exec(e))!==null;){let n=s[0],l=n.split(`
`).slice(1,-1).join(`
`);r=r.replace(n,l)}return r.trim()}removeExcessiveNewlines(){return this.formattedCompletion=this.formattedCompletion.replace(/\n{3,}/g,`

`),this}build(){return this.formattedCompletion}};var b=class{constructor(e,t){this.cursorPosition=e,this.model=t}shouldProvideCompletions(){return!te(this.cursorPosition,this.model)&&!re(this.cursorPosition,this.model)}};var v=class v{constructor(){this.cache=[]}getCompletionCache(e,t){return this.cache.filter(r=>this.isCacheItemValid(r,e,t))}addCompletionCache(e){this.cache=[...this.cache.slice(-(v.MAX_CACHE_SIZE-1)),e]}clearCompletionCache(){this.cache=[]}isCacheItemValid(e,t,r){let s=r.getValueInRange(e.range);return g(t,r).startsWith(e.textBeforeCursorInLine)&&this.isPositionValid(e,t,s)}isPositionValid(e,t,r){return e.range.startLineNumber===t.lineNumber&&t.column===e.range.startColumn||e.completion.startsWith(r)&&e.range.startLineNumber===t.lineNumber&&t.column>=e.range.startColumn-r.length&&t.column<=e.range.endColumn}};v.MAX_CACHE_SIZE=10;var O=v;var Te="application/json",ne=async({filename:o,endpoint:e,language:t,technologies:r,externalContext:s,model:n,position:l})=>{try{let{completion:a}=await R.POST(e,{body:{completionMetadata:xe({filename:o,position:l,model:n,language:t,technologies:r,externalContext:s})}},{headers:{"Content-Type":Te},error:"Error while fetching completion item"});return a}catch(a){return c(a,"FETCH_COMPLETION_ITEM_ERROR"),null}},xe=({filename:o,position:e,model:t,language:r,technologies:s,externalContext:n})=>{let l=ye(e,t),a=D(e,t),i=k(e,t);return{filename:o,language:r,technologies:s,externalContext:n,textBeforeCursor:a,textAfterCursor:i,editorState:{completionMode:l}}},ye=(o,e)=>{let t=D(o,e),r=k(o,e);return t&&r?"fill-in-the-middle":"completion"};var ie=(o,e,t,r)=>{let s=(o.match(/\n/g)||[]).length,n=ee(o),l=M(t,r);return{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber+s,endColumn:o.includes(l)?t.lineNumber===e.startLineNumber&&s===0?t.column+(n-1):n:t.column}};function se(o){return I.create(o).removeMarkdownCodeSyntax().removeExcessiveNewlines().removeInvalidLineBreaks().build()}var d=o=>({items:o,enableForwardStability:!0});var Me=300,le=J(ne,Me),L=new O,Re=async({monaco:o,model:e,position:t,token:r,isCompletionAccepted:s,onShowCompletion:n,options:l})=>{if(!new b(t,e).shouldProvideCompletions())return d([]);let a=L.getCompletionCache(t,e).map(i=>({insertText:i.completion,range:i.range}));if(a.length)return n(),d(a);if(r.isCancellationRequested||s)return d([]);try{let i=le({...l,text:e.getValue(),model:e,position:t});r.onCancellationRequested(()=>{le.cancel()});let p=await i;if(p){let u=se(p),m=new o.Range(t.lineNumber,t.column,t.lineNumber,t.column),P=ie(u,m,t,e);return L.addCompletionCache({completion:u,range:P,textBeforeCursorInLine:g(t,e)}),n(),d([{insertText:u,range:P}])}}catch(i){if(typeof i=="string"&&(i==="Cancelled"||i==="AbortError")||i instanceof Error&&(i.message==="Cancelled"||i.name==="AbortError"))return d([]);c(i,"FETCH_COMPLETION_ITEM_ERROR")}return d([])},ae=Re;var f=new WeakMap,E=null,Ie=(o,e,t)=>{E&&E.deregister();let r=[];f.set(e,{isCompletionAccepted:!1,isCompletionVisible:!1});try{let s=o.languages.registerInlineCompletionsProvider(t.language,{provideInlineCompletions:(a,i,p,u)=>{let m=f.get(e);if(m)return ae({monaco:o,model:a,position:i,token:u,isCompletionAccepted:m.isCompletionAccepted,onShowCompletion:()=>{m.isCompletionVisible=!0},options:t})},freeInlineCompletions:()=>{}});r.push(s);let n=e.onKeyDown(a=>{let i=f.get(e);if(!i)return;let p=a.keyCode===o.KeyCode.Tab||a.keyCode===o.KeyCode.RightArrow&&a.metaKey;i.isCompletionVisible&&p?(i.isCompletionAccepted=!0,i.isCompletionVisible=!1):i.isCompletionAccepted=!1});r.push(n);let l={deregister:()=>{r.forEach(a=>a.dispose()),L.clearCompletionCache(),f.delete(e),E=null}};return E=l,l}catch(s){return c(s,"REGISTER_COPILOT_ERROR"),{deregister:()=>{r.forEach(n=>n.dispose()),f.delete(e),E=null}}}};export{B as Copilot,Ie as registerCopilot};
