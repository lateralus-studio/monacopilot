"use strict";var _=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var ge=Object.prototype.hasOwnProperty;var he=(t,e)=>{for(var o in e)_(t,o,{get:e[o],enumerable:!0})},fe=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ce(e))!ge.call(t,n)&&n!==o&&_(t,n,{get:()=>e[n],enumerable:!(r=ue(e,n))||r.enumerable});return t};var Ee=t=>fe(_({},"__esModule",{value:!0}),t);var Ne={};he(Ne,{Copilot:()=>I,registerCopilot:()=>me});module.exports=Ee(Ne);var F={"llama-3-70b":"llama3-70b-8192","gpt-4o":"gpt-4o-2024-08-06","gpt-4o-mini":"gpt-4o-mini","claude-3.5-sonnet":"claude-3.5-sonnet-20240620","claude-3-opus":"claude-3-opus-20240229","claude-3-sonnet":"claude-3-sonnet-20240229","claude-3-haiku":"claude-3-haiku-20240307"},S={groq:["llama-3-70b"],openai:["gpt-4o","gpt-4o-mini"],anthropic:["claude-3.5-sonnet","claude-3-opus","claude-3-haiku","claude-3-sonnet"]},D="llama-3-70b",T="groq",U={groq:"https://api.groq.com/openai/v1/chat/completions",openai:"https://api.openai.com/v1/chat/completions",anthropic:"https://api.anthropic.com/v1/messages"},V=.3;var j=new Set(['"',"'","`","{","}","[","]","(",")",","," ",":","."]);var x=class t{constructor(){}static getInstance(){return t.instance||(t.instance=new t),t.instance}error(e,o){console.error(this.styleMessage(o.message,e,"error")),o.stack&&console.error(this.styleStackTrace(o.stack))}warn(e,o){console.warn(this.styleMessage(o,e,"warning"))}styleMessage(e,o,r){let n=this.getTimestamp(),i="Please create an issue on GitHub if the issue persists.",s=100,l="\u2500".repeat(s-2),a=`\u250C${l}\u2510`,p=`\u2514${l}\u2518`,c=((N,ce)=>{let de=N.split(" "),w=[],C="";return de.forEach(q=>{(C+q).length>ce&&(w.push(C.trim()),C=""),C+=q+" "}),C.trim()&&w.push(C.trim()),w})(e,s-4),P=[a,...c.map(N=>`\u2502 ${N.padEnd(s-4)} \u2502`),p].join(`
`);return`
\x1B[1m\x1B[37m[${n}]\x1B[0m${r==="error"?"\x1B[31m":"\x1B[33m"} [${o}]\x1B[0m \x1B[2m${i}\x1B[0m
${P}
`}styleStackTrace(e){return e.split(`
`).map((n,i)=>i===0?`\x1B[31m${n}\x1B[0m`:`\x1B[2m${n}\x1B[0m`).join(`
`)}getTimestamp(){return new Date().toISOString()}};var h=class h{constructor(){this.logger=x.getInstance()}static getInstance(){return h.instance}handleError(e,o){let r=this.getErrorDetails(e);return this.logger.error(o,r),r}getErrorDetails(e){return e instanceof Error?{message:e.message,name:e.name,stack:e.stack,context:e.context}:{message:String(e),name:"UnknownError"}}};h.instance=new h;var k=h;var m=(t,e)=>k.getInstance().handleError(t,e);var G={"claude-3.5-sonnet":8192,"claude-3-opus":4096,"claude-3-haiku":4096,"claude-3-sonnet":4096};var R="<<CURSOR>>",W=(t,e)=>"You are an advanced AI content creation assistant. Your goal is to provide accurate, efficient, and context-aware completions. Remember, your role is to act as an extension of the writer's thought process, providing intelligent and contextually appropriate content completions.",Y=(t,e)=>{let{editorState:{completionMode:o},textBeforeCursor:r,textAfterCursor:n,externalContext:i}=t,s="You are are given an incomplete piece of content and asked what the following text is. Treat the given content as markdown text.";return s+=`

Here are the details about how the completion should be generated:
  - The cursor position is marked with '${R}'.
  - Your completion must start exactly at the cursor position.
  - Do not repeat any content that appears before or after the cursor.
`,o==="fill-in-the-middle"?s+=`  - If filling in the middle, replace '${R}' entirely with your completion.
`:o==="completion"&&(s+=`  - If completing the code, start from '${R}' and provide a logical continuation.
`),s+=`  - Optimize for readability and effectiveness where possible.

  Remember to output only the completion content without any additional explanation.

  Here's the snippet for completion:

  <code>
  ${r}${R}${n}
  </code>`,i&&i.length>0&&(s+=`

Additional context from related files:

`,s+=i.map(l=>`// Path: ${l.path}
${l.content}
`).join(`
`)),s.endsWith(".")?s:`${s}.`};var K=(t,e,o,r)=>{let n=W(t,r),i=Y(t,r),l={model:Re(e),temperature:V},a={openai:{messages:[{role:"system",content:n},{role:"user",content:i}]},groq:{messages:[{role:"system",content:n},{role:"user",content:i}]},anthropic:{system:n,messages:[{role:"user",content:i}],max_tokens:ye(e)}};return{...l,...a[o]}},X=(t,e)=>{let o={"Content-Type":"application/json"},r={openai:{Authorization:`Bearer ${t}`},groq:{Authorization:`Bearer ${t}`},anthropic:{"x-api-key":t,"anthropic-version":"2023-06-01"}};return{...o,...r[e]}},z=(t,e)=>{let r={openai:Pe,groq:Te,anthropic:xe}[e];if(!r)throw new Error(`Unsupported provider: ${e}`);return r(t)},Pe=t=>t.choices?.length?{completion:t.choices[0].message.content}:{completion:null,error:"No completion found in the openai response"},Te=t=>t.choices?.length?{completion:t.choices[0].message.content}:{completion:null,error:"No completion found in the groq response"},xe=t=>t.content?typeof t.content!="string"?{completion:null,error:"Completion content is not a string"}:{completion:t.content}:{completion:null,error:"No completion found in the anthropic response"},Re=t=>F[t],J=t=>U[t],ye=t=>G[t]||4096;var Z=(t,e)=>{let o=null,r=null,n=(...i)=>new Promise((s,l)=>{o&&(clearTimeout(o),r&&r("Cancelled")),r=l,o=setTimeout(()=>{s(t(...i)),r=null},e)});return n.cancel=()=>{o&&(clearTimeout(o),r&&r("Cancelled"),o=null,r=null)},n},Q=t=>!t||t.length===0?"":t.length===1?t[0]:`${t.slice(0,-1).join(", ")} and ${t.slice(-1)}`;var y=(t,e)=>e.getLineContent(t.lineNumber)[t.column-1],ee=(t,e)=>e.getLineContent(t.lineNumber).slice(t.column-1),g=(t,e)=>e.getLineContent(t.lineNumber).slice(0,t.column-1),te=t=>{let e=t.split(`
`);return e[e.length-1].length+1};var B=(t,e)=>e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:t.lineNumber,endColumn:t.column}),H=(t,e)=>e.getValueInRange({startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:e.getLineCount(),endColumn:e.getLineMaxColumn(e.getLineCount())});var oe=async(t,e,o={})=>{let r={"Content-Type":"application/json",...o.headers},n=e==="POST"&&o.body?JSON.stringify(o.body):void 0,i=await fetch(t,{method:e,headers:r,body:n,signal:o.signal});if(!i.ok)throw new Error(`${o.error||"Network error"}: ${i.statusText}`);return i.json()},Me=(t,e)=>oe(t,"GET",e),Ie=(t,e,o)=>oe(t,"POST",{...o,body:e}),M={GET:Me,POST:Ie};var re=(t,e)=>{let o=y(t,e);return!!o&&!j.has(o)},ne=(t,e)=>{let o=ee(t,e).trim(),r=g(t,e).trim();return t.column<=3&&(o!==""||r!=="")};var I=class{constructor(e,o={}){this.validateInputs(e,o),this.apiKey=e,this.provider=o.provider??T,this.model=o.model??D}async complete({body:e,options:o}){let{completionMetadata:r}=e,{headers:n={}}=o??{};try{let i=K(r,this.model,this.provider,o),s=J(this.provider),l=X(this.apiKey,this.provider),a={...n,...l},p=await M.POST(s,i,{headers:a});return z(p,this.provider)}catch(i){return{error:m(i,"COPILOT_COMPLETION_FETCH_ERROR").message,completion:null}}}validateInputs(e,o){if(!e)throw new Error(`Please provide ${this.provider??T} API key.`);let{provider:r,model:n}=o;if(r&&!n||!r&&n)throw new Error("Both provider and model must be specified together");let i=r??T,s=n??D;if(!S[i].includes(s)){let l=Q(S[i]);throw new Error(`Model ${s} is not supported by ${i} provider. Supported models: ${l}`)}}};var O=class t{constructor(e){this.formattedCompletion="";this.formattedCompletion=e}static create(e){return new t(e)}setCompletion(e){return this.formattedCompletion=e,this}removeInvalidLineBreaks(){return this.formattedCompletion=this.formattedCompletion.trimEnd(),this}removeMarkdownCodeSyntax(){return this.formattedCompletion=this.removeMarkdownCodeBlocks(this.formattedCompletion),this}removeMarkdownCodeBlocks(e){let o=/```[\s\S]*?```/g,r=e,n;for(;(n=o.exec(e))!==null;){let i=n[0],s=i.split(`
`).slice(1,-1).join(`
`);r=r.replace(i,s)}return r.trim()}removeExcessiveNewlines(){return this.formattedCompletion=this.formattedCompletion.replace(/\n{3,}/g,`

`),this}build(){return this.formattedCompletion}};var b=class{constructor(e,o){this.cursorPosition=e,this.model=o}shouldProvideCompletions(){return!re(this.cursorPosition,this.model)&&!ne(this.cursorPosition,this.model)}};var L=class L{constructor(){this.cache=[]}getCompletionCache(e,o){return this.cache.filter(r=>this.isCacheItemValid(r,e,o))}addCompletionCache(e){this.cache=[...this.cache.slice(-(L.MAX_CACHE_SIZE-1)),e]}clearCompletionCache(){this.cache=[]}isCacheItemValid(e,o,r){let n=r.getValueInRange(e.range);return g(o,r).startsWith(e.textBeforeCursorInLine)&&this.isPositionValid(e,o,n)}isPositionValid(e,o,r){return e.range.startLineNumber===o.lineNumber&&o.column===e.range.startColumn||e.completion.startsWith(r)&&e.range.startLineNumber===o.lineNumber&&o.column>=e.range.startColumn-r.length&&o.column<=e.range.endColumn}};L.MAX_CACHE_SIZE=10;var v=L;var Oe="application/json",ie=async({filename:t,endpoint:e,language:o,technologies:r,externalContext:n,model:i,position:s})=>{try{let{completion:l}=await M.POST(e,{body:{completionMetadata:be({filename:t,position:s,model:i,language:o,technologies:r,externalContext:n})}},{headers:{"Content-Type":Oe},error:"Error while fetching completion item"});return l}catch(l){return m(l,"FETCH_COMPLETION_ITEM_ERROR"),null}},be=({filename:t,position:e,model:o,language:r,technologies:n,externalContext:i})=>{let s=ve(e,o),l=B(e,o),a=H(e,o);return{filename:t,language:r,technologies:n,externalContext:i,textBeforeCursor:l,textAfterCursor:a,editorState:{completionMode:s}}},ve=(t,e)=>{let o=B(t,e),r=H(t,e);return o&&r?"fill-in-the-middle":"completion"};var se=(t,e,o,r)=>{let n=(t.match(/\n/g)||[]).length,i=te(t),s=y(o,r);return{startLineNumber:o.lineNumber,startColumn:o.column,endLineNumber:o.lineNumber+n,endColumn:t.includes(s)?o.lineNumber===e.startLineNumber&&n===0?o.column+(i-1):i:o.column}};function le(t){return O.create(t).removeMarkdownCodeSyntax().removeExcessiveNewlines().removeInvalidLineBreaks().build()}var d=t=>({items:t,enableForwardStability:!0});var Le=300,ae=Z(ie,Le),A=new v,Ae=async({monaco:t,model:e,position:o,token:r,isCompletionAccepted:n,onShowCompletion:i,options:s})=>{if(!new b(o,e).shouldProvideCompletions())return d([]);let l=A.getCompletionCache(o,e).map(a=>({insertText:a.completion,range:a.range}));if(l.length)return i(),d(l);if(r.isCancellationRequested||n)return d([]);try{let a=ae({...s,text:e.getValue(),model:e,position:o});r.onCancellationRequested(()=>{ae.cancel()});let p=await a;if(p){let u=le(p),c=new t.Range(o.lineNumber,o.column,o.lineNumber,o.column),P=se(u,c,o,e);return A.addCompletionCache({completion:u,range:P,textBeforeCursorInLine:g(o,e)}),i(),d([{insertText:u,range:P}])}}catch(a){if(typeof a=="string"&&(a==="Cancelled"||a==="AbortError")||a instanceof Error&&(a.message==="Cancelled"||a.name==="AbortError"))return d([]);m(a,"FETCH_COMPLETION_ITEM_ERROR")}return d([])},pe=Ae;var f=new WeakMap,E=null,me=(t,e,o)=>{E&&E.deregister();let r=[];f.set(e,{isCompletionAccepted:!1,isCompletionVisible:!1});try{let n=t.languages.registerInlineCompletionsProvider(o.language,{provideInlineCompletions:(l,a,p,u)=>{let c=f.get(e);if(c)return pe({monaco:t,model:l,position:a,token:u,isCompletionAccepted:c.isCompletionAccepted,onShowCompletion:()=>{c.isCompletionVisible=!0},options:o})},freeInlineCompletions:()=>{}});r.push(n);let i=e.onKeyDown(l=>{let a=f.get(e);if(!a)return;let p=l.keyCode===t.KeyCode.Tab||l.keyCode===t.KeyCode.RightArrow&&l.metaKey;a.isCompletionVisible&&p?(a.isCompletionAccepted=!0,a.isCompletionVisible=!1):a.isCompletionAccepted=!1});r.push(i);let s={deregister:()=>{r.forEach(l=>l.dispose()),A.clearCompletionCache(),f.delete(e),E=null}};return E=s,s}catch(n){return m(n,"REGISTER_COPILOT_ERROR"),{deregister:()=>{r.forEach(i=>i.dispose()),f.delete(e),E=null}}}};0&&(module.exports={Copilot,registerCopilot});
